<!DOCTYPE html>
<html>
<head>
    <title id="hw_title"></title>
    <link rel="stylesheet" href="../css/default.css" />
    <script src="../js/dbtools.js"></script>
    <script src="../js/dispatchHandler.js"></script>
</head>
<body onload="javascript: dispatcher.GeneratePage(document.getElementById('hw_questionSelect').value);">
    <div id="hw_loadingContent">
        <p>Loading...</p>
    </div>
    <div id="hw_allContent">
        <!--hw_fixedContent are elements that should exists on every page and do not change much-->
        <div id="hw_fixedContent">
            <span class="hw quest_select">
                Select a Question:
                <select id="hw_questionSelect" onchange="javascript: dispatcher.GeneratePage(document.getElementById('hw_questionSelect').value);">
                    <option value="Q1A">Question 1: Part A</option>
					<option value="Q1B">Question 1: Part B</option>
                    <option value="Q1C">Question 1: Part C</option>
                </select>
            </span>
        </div>
        <h3 class="hw" id="hw_heading"></h3>
        <div id="hw_dynamicContent"></div>
    </div>
    <script>
        //Removes all child nodes from the main content
        function Clear_DynamicContentNodes() {
            let doc = document.getElementById('hw_dynamicContent');
            while (doc.firstChild) {
                doc.removeChild(doc.firstChild);
            }
        }
		//Removes all child nodes of element with given id
		function Clear_ByElementId(elemID) {
			let e = document.getElementById(elemID);
			if(e !== null) {
				while(e.firstChild) {
					e.removeChild(e.firstChild);
				}
			}
		}
        //Hide "hw_allContent" div and show "hw_loadingContent" div
        function Hide_AllContentNodes(makeHidden) {
            let doc = document.getElementById('hw_allContent');
            let ld = document.getElementById('hw_loadingContent');
            if (makeHidden === undefined || !(makeHidden === false)) {
                makeHidden = true;
            }
            if (makeHidden) {
                doc.setAttribute('hidden', 'true');
                ld.removeAttribute('hidden');
            } else {
                doc.removeAttribute('hidden');
                ld.setAttribute('hidden', 'true');
            }
        }
        //Changes title
        function Alter_Title(str) {
            document.getElementById('hw_title').innerText = str;
        }
        //Changes fixed page heading
        function Alter_Heading(str) {
            document.getElementById('hw_heading').innerText = str;
        }
		
        //Generic callback for XMLHttpResponse
        function Insert_ResponseText(res, elemID) {
            if (document.getElementById(elemID) === null) {
                console.log(elemID + " was not found.");
            } else {
                document.getElementById(elemID).appendChild(document.createElement('div'));
                document.getElementById(elemID).lastChild.outerHTML = res.responseText;
            }
        }

		//Appends user table to given element
		function Insert_UserTable(elemID) {
			if(document.getElementById(elemID) === null) {
				console.log(elemID + " was not found.");
			} else {
				getUserTable(
					function(res) {
					document.getElementById(elemID).appendChild(document.createElement('div'));
					document.getElementById(elemID).lastChild.outerHTML = res.responseText;
					},
					false);
			}
		}
		//Appends user summary table to given element
		function Insert_UserSummaryTable(elemID) {
			if(document.getElementById(elemID) === null) {
				console.log(elemID + " was not found.");
			} else {
				getUserSummaryTable(
					function(res) {
						document.getElementById(elemID).appendChild(document.createElement('div'));
						document.getElementById(elemID).lastChild.outerHTML = res.responseText;
					},
					false);
			}
		}
        
        //Q1A Related functions
        function Q1A_GeneratePage() {
            Hide_AllContentNodes(true);
            Alter_Title('Question 1: Part A');
            Alter_Heading('The table below displays the current users already in the database. Please create a user account. After creating the account you should see it displayed in the user table.');
            //adds a div element and 2 child div elements that float left (form0) and right (table0)
            Q1A_AddContentBox();
			Clear_ByElementId('table0');
			Insert_UserTable('table0');
            Q1A_AddSignUpForm();
            Hide_AllContentNodes(false);
        }

        function Q1A_AddContentBox() {
            var doc = document.getElementById('hw_dynamicContent');
            var cbox = document.createElement('div');
            cbox.setAttribute('id', 'hw_Q1A_contentBox');
            cbox.appendChild(document.createElement('div'));
            cbox.lastChild.setAttribute('id', 'form0');
            cbox.lastChild.setAttribute('style', 'float:left');
            cbox.appendChild(document.createElement('div'));
            cbox.lastChild.setAttribute('id', 'table0');
            cbox.lastChild.setAttribute('style', 'float:left; margin-left: 5%;');

            doc.appendChild(cbox);
        }

        function Q1A_AddSignUpForm() {
            var doc = document.getElementById('form0');
			Clear_ByElementId('signUpForm');
            doc.appendChild(document.createElement('div'));
            doc.lastChild.outerHTML = "<form action=\"javascript:Q1A_SignUpNewUser()\" method=\"post\" id=\"signUpForm\">" +
                    "<table id=\"formFields\">" +
                    "<tr>" +
                        "<td>User Name:</td>" +
                        "<td><input type=\"text\" id=\"name\" name=\"name\" size=\"32\" required placeholder=\"Enter User Name...\" /></td> <!--this will be inserted to user.user_name in MySQl database-->" +
                    "</tr>" +
                    "<tr>" +
                    "    <td>Email:</td> " +
                    "    <td><input type=\"email\" id=\"email\" name=\"email\" size=\"128\" required placeholder=\"Enter Email Address...\" /></td> <!--this will be inserted to user.email in MySQL database--> " +
                    "</tr> " +
                    "<tr> " +
                    "    <td>User Type:</td> " +
                    "    <td><select id=\"userTypes\"></select></td> " +
                    "</tr> " +
                    "<tr> " +
                    "    <td>Password:</td> " +
                    "    <td><input type=\"password\" id=\"password\" name=\"password\" required placeholder=\"Enter a password...\" /></td> " +
                    "</tr> " +
                    "<tr> " +
                    "    <td></td> " +
                    "    <td><input type=\"submit\" name=\"submit\" value=\"Sign Up\" /></td> " +
                    "</tr> " +
                "</table> " +
            "</form>";
            userTypesSelectList(
                function (res) {
                    document.getElementById('userTypes').outerHTML = "<select id=\"userTypes\">" + res.responseText + "</select>"; //the XMLHttpRequest will return all valid user types found in the database. Each type will be enclosed in <option> tags. Thus, responseText is a string of user types enclosed in option tags sent from the server.
                });
            doc.lastElementChild.setAttribute('class', 'usr-form');
            doc.lastElementChild.setAttribute('style', 'width:100%;clear:both;float:left;');
            
        }
		//inserts new user to the user table
		function Q1A_SignUpNewUser() {
			let name = document.getElementById('name').value;
			let email = document.getElementById('email').value;
			let type = document.getElementById('userTypes').value;
			let password = document.getElementById('password').value;
			if(document.getElementById('msg0') === null) {
				document.getElementById('signUpForm').appendChild(document.createElement('p'));
				document.getElementById('signUpForm').lastElementChild.setAttribute('id','msg0');
			}
			signUp(
				function(res) {
					if(res.responseText === "") {
					    Clear_ByElementId('table0');
					    Insert_UserTable('table0');
						document.getElementById('msg0').innerText = "You should see the new user account in the table to the right.";
					} else {
						document.getElementById('msg0').innerText = res.responseText;
					}
				},
				name,
				email,
				type,
				password,
				false);
		}
        function Q1A_CleanPage() {
            Hide_AllContentNodes(true);
            Clear_DynamicContentNodes();
            
            Hide_AllContentNodes(false);
        }
		
		//Q1B functions
		function Q1B_GeneratePage() {
			Hide_AllContentNodes(true);
			Alter_Title("Question 1: Part B");
			Alter_Heading("The table on the left is the user table. The table on the right is a query of the user table grouped by user type with aggregate functions COUNT(user_id) and MAX(reg_date)");
			Q1B_AddContentBox();
            Insert_UserTable('table0');
            //document.getElementsByClassName('usr-frm').firstChild.setAttribute('style', 'max-width: 50%;');
            Insert_UserSummaryTable('table1');
            document.getElementById('table1').getElementsByTagName('table')[0].setAttribute('style', 'width: 100%'); //php function sets width to 50% by default, just removing it here instead of in php
			Hide_AllContentNodes(false);
		}
		function Q1B_AddContentBox() {
            var doc = document.getElementById('hw_dynamicContent');
            var cbox = document.createElement('div');
            cbox.setAttribute('id', 'hw_Q1B_contentBox');
            cbox.appendChild(document.createElement('div'));
            cbox.lastChild.setAttribute('id', 'table0');
            cbox.lastChild.setAttribute('style', 'float:left;max-width: 48%;');
            cbox.appendChild(document.createElement('div'));
            cbox.lastChild.setAttribute('id', 'table1');
            cbox.lastChild.setAttribute('style', 'float:left;margin-left: 5%;max-width: 48%;');
            doc.appendChild(cbox);		
		}
		
		function Q1B_CleanPage() {
			Hide_AllContentNodes(true);
			Clear_DynamicContentNodes();
			Hide_AllContentNodes(false);
        }

        function Q1C_GeneratePage() {
            Hide_AllContentNodes(true);
            Alter_Title('Question 1: Part C');
            Alter_Heading('Below is a query that displays the name of each location (from the location table), the number of entrees and average entree price by location (from the entree table).');
            Q1C_AddContentBox();
            getLocEntreeSummaryTable(Insert_ResponseText, 'queryTable', false);
            Hide_AllContentNodes(false);

        }

        function Q1C_AddContentBox() {
            let doc = document.getElementById('hw_dynamicContent');
            let box0 = document.createElement('div'); //for query
            let box1 = document.createElement('div'); //for original tables
            let locBox = document.createElement('div'); //for location table and title
            let entreeBox = document.createElement('div'); //for entree table and title
            let t0 = document.createElement('div'); //for query table
            let t1 = document.createElement('div'); //for location table
            let t2 = document.createElement('div'); //for entree table
            let h0 = document.createElement('h3'); //For query table title
            let h1 = document.createElement('h3'); //For location table title
            let h2 = document.createElement('h3'); //For entree table title

            //setting id attributes of elements
            box0.setAttribute('id', 'queryBox');
            box1.setAttribute('id', 'baseTableBox');
            locBox.setAttribute('id', 'locBox');
            entreeBox.setAttribute('id', 'entreeBox');

            t0.setAttribute('id', 'queryTable');
            t1.setAttribute('id', 'locTable');
            t2.setAttribute('id', 'entreeTable');

            h0.setAttribute('id', 'queryTableTitle');
            h1.setAttribute('id', 'locTableTitle');
            h2.setAttribute('id', 'entreeTableTitle');
            
            //assign text to table titles
            h0.innerText = "Query on two base tables with two aggregate functions.";
            h1.innerText = "Location (base table)";
            h2.innerText = "Entree (base table)";

            //setting style attributes of elements
            t0.setAttribute('style', 'width:100%');
            locBox.setAttribute('style', 'max-width:48%;float:left');
            entreeBox.setAttribute('style', 'max-width:48%;float:left;margin-left:5%');
            h1.setAttribute('style', 'clear:both;');
            h2.setAttribute('style', 'clear:both;');
            t1.setAttribute('style', 'clear:both;');
            t2.setAttribute('style', 'clear:both;');
            box1.setAttribute('style', 'margin-top: 5%;')
            //append elements to boxes
            locBox.appendChild(h1);
            locBox.appendChild(t1);
            entreeBox.appendChild(h2);
            entreeBox.appendChild(t2);
            box0.appendChild(h0);
            box0.appendChild(t0);
            box1.appendChild(locBox);
            box1.appendChild(entreeBox);
            doc.appendChild(box0);
            doc.appendChild(box1);
        }

        function Q1C_CleanPage() {
            Hide_AllContentNodes(true);
            Clear_DynamicContentNodes();
            Hide_AllContentNodes(false)
        }
		var dispatcher = new DispatchHandler();
        function Init() {
            dispatcher.InsertPageHandler("Q1A", Q1A_GeneratePage, Q1A_CleanPage);
            dispatcher.InsertPageHandler("Q1B", Q1B_GeneratePage, Q1B_CleanPage);
            dispatcher.InsertPageHandler("Q1C", Q1C_GeneratePage, Q1C_CleanPage);
        }
		Init();
        
        
        
    </script>
</body>
</html>